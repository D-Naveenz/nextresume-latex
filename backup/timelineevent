% Counter for timeline events
\newcounter{timelineevent}

% Modern dynamic timeline implementation
\newenvironment{nexttimeline}{%
  \setcounter{timelineevent}{0}
  \def\lastbottom{0}% Initialize bottom position tracker
  
  % Calculate dynamic widths based on available space
  \pgfmathsetmacro{\datewidth}{2.3}% Date column width in cm
  \pgfmathsetmacro{\timelinegap}{0.5}% Gap from center to date (left side)
  \pgfmathsetmacro{\eventgap}{1}% Gap from center to event (right side)  
  \pgfmathsetmacro{\timelinethickness}{0.1}% Timeline thickness in cm
  \pgfmathsetmacro{\eventpadding}{0.3}% Internal padding for event box
  \pgfmathsetmacro{\safemargin}{0.2}% Safety margin to prevent overfull boxes
  
  % Calculate available width for event box
  % Total available = \linewidth - date width - gaps - timeline thickness - padding - safety margin
  \pgfmathsetmacro{\availablewidth}{\linewidth/1cm - \datewidth - \timelinegap - \eventgap - \timelinethickness - 2*\eventpadding - \safemargin}
  \pgfmathsetmacro{\eventtextwidth}{\availablewidth - 0.4}% Subtract for borders
  
  % Declare layers before starting tikzpicture
  \pgfdeclarelayer{background}% For timeline
  \pgfdeclarelayer{circles}% For both big and small circles
  \pgfsetlayers{background,circles,main}%
  \begin{tikzpicture}[
    % These styles apply to ALL elements in this tikzpicture
    event/.style={
      rectangle, 
      draw=accent!60, 
      fill=body!5, 
      thick,
      minimum width=\availablewidth cm,
      text width=\eventtextwidth cm,
      align=left,
      rounded corners=4pt,
      inner sep=\eventpadding cm
    },
    date/.style={
      text width=\datewidth cm,
      align=right,
      anchor=east,
      font=\color{emphasis}
    },
    timeline/.style={
      draw=accent!80, 
      thick, 
      line width=2pt
    },
    dot/.style={
      circle,
      fill=accent,
      minimum size=8pt,
      inner sep=0pt
    },
    bigcircle/.style={
      circle,
      draw=accent,
      fill=white,
      thick,
      minimum size=15pt,
      inner sep=0pt
    }
  ]
  % Initialize timeline bounds tracking
  \def\timelinetop{0.8}% Start above first event (using eventspacing value)
  \def\timelinebottom{-0.8}% Will be updated as events are added

  % Command to add timeline events
  \newcommand{\nexttimelineevent}[2]{%
    \stepcounter{timelineevent}%
    % Calculate position based on previous event's bottom plus spacing
    \pgfmathsetmacro{\eventspacing}{0.8}% Spacing between events in cm
    
    % For first event, use initial position; for subsequent events, use last bottom minus spacing
    \ifnum\thetimelineevent=1%
      \pgfmathsetmacro{\ypos}{0}%
    \else%
      \pgfmathsetmacro{\ypos}{\lastbottom - \eventspacing}%
    \fi
    
    \coordinate (pos\thetimelineevent) at (0,\ypos);
    
    % Date/location node (left side) - use calculated gap
    \node[date, anchor=north east] (date\thetimelineevent) at ($(pos\thetimelineevent) + (-\timelinegap,0)$) {##1};
    
    % Content node (right side) - use calculated gap
    \node[event, anchor=north west] (event\thetimelineevent) at ($(pos\thetimelineevent) + (\eventgap,0)$) {##2};
    
    % Draw circles on the circles layer
    \begin{pgfonlayer}{circles}
      % Big circle with white fill covers the timeline
      \node[bigcircle] at (0, 0 |- date\thetimelineevent.center) {};
      % Small dot on top of big circle
      \node[dot] at (0, 0 |- date\thetimelineevent.center) {};
    \end{pgfonlayer}
    
    % Update the bottom position for next event
    % Use the minimum of date and event bottom positions (most negative y-coordinate)
    \pgfpointanchor{date\thetimelineevent}{south}
    \pgfgetlastxy{\tempx}{\datebottom}
    \pgfpointanchor{event\thetimelineevent}{south}
    \pgfgetlastxy{\tempx}{\eventbottom}
    \pgfmathsetmacro{\tempbottom}{min(\datebottom/1cm,\eventbottom/1cm)}
    \xdef\lastbottom{\tempbottom}
    
    % Update timeline bottom to extend below the last event
    \pgfmathsetmacro{\newtimelinebottom}{\tempbottom - \eventspacing}
    \xdef\timelinebottom{\newtimelinebottom}
  }

  \NewDocumentCommand{\DateAndLocation}{m O{}}{%
    \textbf{##1} \\ {\small##2}%
  }

  \newcommand{\ExerienceHeading}[2]{
    {\large\bfseries\color{emphasis}##1}\par
    \smallskip
    \ifstrequal{##2}{}{}{%
      \normalsize\textbf{\color{subheading}##2}\par
      \smallskip
    }%
  }

  \newcolumntype{Y}{>{\raggedright\arraybackslash}X}
  \newcommand{\Heading}[3]{%
    %% Header
    {
      \setsepchar{,}%  
      \readlist*\titlelist{##1}%
      %% Check tiltlelist has more than 1 elements
      \ifnum\titlelistlen>1
        \begin{tabularx}{\columnwidth}{@{}l | Y@{}}
          \large\textcolor{subheading}{\textbf{\titlelist[1]}} & \textcolor{emphasis}{\textbf{\titlelist[2]}} \\
        \end{tabularx}\par
      \else
        \large\textcolor{emphasis}{\textbf{##1}}\par
      \fi
      \smallskip\normalsize
      \let\titlelist\relax
    }
    %% Role
    {%
      {\small\color{emphasis}\makebox[0.5\linewidth][l]%
          {\BeginAccSupp{method=pdfstringdef,ActualText={\rolename:}}\nextProjectRoleMarker\EndAccSupp{}%
            ~\normalfont\ifstrequal{##2}{}{Personal Project}{##2}}%
        }%
    }%
    %% [Optional] Project Link (If this is a project heading)
    \ifstrequal{##3}{}{}{%
      % The parsing-separator⟨delimiter⟩“/” is reserved by default for nested lists
      %  To set “/” as the ⟨parsing-separator⟩ for a simple list, it is necessary, using the optional argument
      \setsepchar[,]{/}%
      \readlist*\urllist{##3}%
      {\small\color{emphasis}\makebox[0.5\linewidth][r]%
        {\BeginAccSupp{method=pdfstringdef,ActualText={\projectlink:}}\nextProjectLinkMarker\EndAccSupp{}%
          ~\normalfont\href{##3}{\textbf{GitHub: }\urllist[-1]}}%
      }%
      \let\urllist\relax
    }\par\smallskip
  }%
}{
  % Draw everything at the end
  \ifnum\thetimelineevent>0%
    % LAYER 1: Draw timeline on background layer (behind everything)
    \begin{pgfonlayer}{background}
      \draw[timeline] (0,\timelinetop) -- (0,\timelinebottom);
    \end{pgfonlayer}
  \fi
  \end{tikzpicture}
}